<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lynn&#39;s Blog</title>
  
  
  <link href="http://lzreload.com/en/atom.xml" rel="self"/>
  
  <link href="http://lzreload.com/en/"/>
  <updated>2022-09-16T11:31:43.783Z</updated>
  <id>http://lzreload.com/en/</id>
  
  <author>
    <name>Lynn Zhou</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>About Docker network - Part 1</title>
    <link href="http://lzreload.com/en/2022/09/16/Docker-NetWork-1/"/>
    <id>http://lzreload.com/en/2022/09/16/Docker-NetWork-1/</id>
    <published>2022-09-16T10:40:25.000Z</published>
    <updated>2022-09-16T11:31:43.783Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>According to docker’s official document, docker’s networking subsystem(libnetwork) is portable, it’s using driver to provide networking functionality. Currently, these drivers exist by default:</p><ul><li>bridge</li><li>host</li><li>overlay</li><li>ipvlan</li><li>macvlan</li></ul><p>If we use <code>docker network ls</code> command to list networks offered by docker by default we can see:</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">$ docker network lsNETWORK ID     NAME      DRIVER    SCOPE2fd34f93b369   bridge    bridge    local8e489d56f4d5   host      host      local2f7960394c0f   none      null      local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>None</code>, <code>host</code>, and <code>bridge</code> network are created by default once docker starts. <code>host</code> and <code>bridge</code> network is using <code>host</code> and <code>bridge</code> driver respectively mentioned above while <code>none</code> network is created without network driver. These three networks will be discussed in this article mainly about how containers will act when they are connected to different networks.</p><h1 id="None"><a href="#None" class="headerlink" title="None"></a>None</h1><p>Containers that are connected to <code>none</code> ****network will not have an external network interface:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Create a container with `none` network mode </span>$ docker run --rm -dit --network none --name no-net-alpine alpine:latest ash<span class="token comment"># Check container's network</span>$ docker <span class="token builtin class-name">exec</span> no-net-alpine <span class="token function">ip</span> <span class="token function">link</span> show<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN qlen <span class="token number">1000</span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Container with this mode of networking will only have a loopback interface, which means that it’s unable to send messages to other containers or external networks.</p><h1 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h1><p>Before we create a new container, we can inspect the network interface of the host first:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Local host</span>$ <span class="token function">ifconfig</span>docker0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">409</span><span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class="token operator">></span>  mtu <span class="token number">1500</span>        inet <span class="token number">172.17</span>.0.1  netmask <span class="token number">255.255</span>.0.0  broadcast <span class="token number">172.17</span>.255.255<span class="token punctuation">..</span>.ens192: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu <span class="token number">1500</span><span class="token punctuation">..</span>.lo: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">7</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu <span class="token number">65536</span>        inet <span class="token number">127.0</span>.0.1  netmask <span class="token number">255.0</span>.0.0<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then, let’s create a new container and connect it to the <code>host</code> network:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Create a new container with host network mode</span>$ docker run --rm -dit --network <span class="token function">host</span> --name host-alpine alpine:latest ash<span class="token comment"># Access to new container</span>$ docker <span class="token builtin class-name">exec</span> -it host-alpine /bin/sh<span class="token comment"># Container host-alpine</span>$ <span class="token function">ifconfig</span>docker0   Link encap:Ethernet  HWaddr 02:42:D3:3C:90:82            inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0<span class="token punctuation">..</span>.ens192    Link encap:Ethernet  HWaddr 00:50:56:BA:06:B7  <span class="token punctuation">..</span>.lo        Link encap:Local Loopback            inet addr:127.0.0.1  Mask:255.0.0.0<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>According to the container shown above, we can observe that this new container has exact same network interfaces as the host which means that, it shares the host’s networking namespaces.</p><p>We can just consider it a normal app running on our computer. For example, we can also create an Nginx container with <code>host</code> network:</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># Host (No need to add --p to expose port 80 when using host network)</span>$ docker run --rm -d --network host --name my_nginx nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Then we can try to sent request to Nginx from Container host-alpine:</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># Access previous host container(host-alpine)</span>$ docker exec -it host-alpine /bin/sh<span class="token comment"># Container host-alpine</span>$ curl localhost:80&lt;!DOCTYPE html>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Since container <code>my_nginx</code> and <code>host-alpine</code> are all connecting to <code>host</code> network, they all share the host’s network namespace, so that <code>host-alpine</code> can directly use <code>localhost:80</code> to send requests to <code>my_nginx</code>.</p><h1 id="Bridge"><a href="#Bridge" class="headerlink" title="Bridge"></a>Bridge</h1><h2 id="About-Bridge-mode"><a href="#About-Bridge-mode" class="headerlink" title="About Bridge mode"></a>About Bridge mode</h2><p><code>Bridge</code> is the default network driver of docker. </p><p>When we talk about <code>bridge network</code>, we are talking about a Link Layer device(a hardware device or a software device) that forwards traffic between network segments.</p><p>In <code>Docker</code>, a software bridge is used for containers to connect to the same bridge network in order to communicate with each other.</p><p>Before we start to create a container with <code>bridge</code> network type, we can check the initial state of our local environment first:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Inspect the ethernet bridge configuration</span>$ brctl showbridge name     bridge <span class="token function">id</span>               STP enabled     interfacesdocker0         <span class="token number">8000</span>.02428ab4554d       no$ <span class="token function">ip</span> <span class="token function">link</span> show<span class="token punctuation">..</span>.<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN mode DEFAULT group default     link/ether 02:42:8a:b4:55:4d brd ff:ff:ff:ff:ff:ff<span class="token punctuation">..</span>.<span class="token comment"># Show IP routing table</span>$ route -nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface<span class="token number">0.0</span>.0.0         <span class="token number">10.103</span>.226.1    <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens192<span class="token number">10.103</span>.226.0    <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens192<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> docker0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Create-container-with-bridge-mode-default"><a href="#Create-container-with-bridge-mode-default" class="headerlink" title="Create container with bridge mode(default):"></a>Create container with bridge mode(default):</h2><p>Then we can start to create a container:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Create a container with `bridge` network type</span>$ docker run --rm -dit --name bridge-alpine alpine ash<span class="token comment"># Check ips of container</span>$ docker <span class="token builtin class-name">exec</span> bridge-alpine <span class="token function">ip</span> addr<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN qlen <span class="token number">1000</span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo       valid_lft forever preferred_lft forever<span class="token number">7</span>: eth0@if8: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff    inet <span class="token number">172.17</span>.0.2/16 brd <span class="token number">172.17</span>.255.255 scope global eth0       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Compared to the previous container with <code>none</code> network mode, this new container has one more network interface <code>eth0</code> and got an ip <code>172.17.0.2</code>.</p><p>Then we can check the network state of the current environment:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Inspect the ethernet bridge configuration</span>$ brctl showbridge name     bridge <span class="token function">id</span>               STP enabled     interfacesdocker0         <span class="token number">8000</span>.0242a1f90aad       no              veth80ec58c$ <span class="token function">ip</span> <span class="token function">link</span> show<span class="token punctuation">..</span>.<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP mode DEFAULT group default     link/ether 02:42:8a:b4:55:4d brd ff:ff:ff:ff:ff:ff<span class="token number">8</span>: veth80ec58c@if7: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue master docker0 state UP mode DEFAULT group default     link/ether 0e:e2:2d:20:d2:ad brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Apparently, now that there’s a new interface <code>veth80ec58c</code> who is connecting to docker0. And also this new interface(<code>veth80ec58c</code>) and <code>interface 7</code> (shown in the container as interface <code>eth0</code>) are two connected endpoints of a <code>veth pair</code> that act as tunnels between network namespaces.</p><p><img src="docker_bridge.png" alt="docker_bridge.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="docker_bridge.png" class="lozad post-image"></p><h2 id="Communication-between-pods"><a href="#Communication-between-pods" class="headerlink" title="Communication between pods"></a>Communication between pods</h2><p> Now that we can create another two containers <code>bridge-alpine2</code> and <code>bridge-alpine3</code>:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Create a new container</span>$ docker run --rm -dit --name bridge-alpine2 alpine ash$ docker run --rm -dit --name bridge-alpine3 alpine ash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Then we can observe that there’re two new interfaces that are connecting to docker0:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ brctl show                    bridge name     bridge <span class="token function">id</span>       STP enabled       interfacesdocker0         <span class="token number">8000</span>.0242a1f90aad       no       veth4a318ba                                                 veth80ec58c                                                 vethd234967<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> We are going to ping container <code>bridge-alpine</code> from container <code>bridge-alpine2</code> using its IP (<code>172.17.0.2</code>) to observe the communication between pods.:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -it bridge-alpine2 /bin/sh<span class="token comment"># Inside container bridge-alpine2(172.17.0.3)</span>$ <span class="token function">ping</span> <span class="token number">172.17</span>.0.2PING <span class="token number">172.17</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.333</span> ms<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.151</span> ms<span class="token comment"># Host</span><span class="token comment"># Capture package from docker0</span>$ tcpdump -i docker0 -v -nn -e -ttcpdump: listening on docker0, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes02:42:ac:11:00:03 <span class="token operator">></span> **ff:ff:ff:ff:ff:ff**, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">7910</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59835</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">7986</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span><span class="token comment"># Container bridge-alpine2</span>$ tcpdump -i veth4a318ba -v -nn -e -t02:42:ac:11:00:03 <span class="token operator">></span> ff:ff:ff:ff:ff:ff, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">56762</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">17</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">55430</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">17</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span class="token comment"># Container bridge-alpine</span>$ tcpdump -i veth80ec58c -v -nn -e -ttcpdump: listening on veth80ec58c, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes02:42:ac:11:00:03 <span class="token operator">></span> ff:ff:ff:ff:ff:ff, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">7910</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59835</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span class="token comment"># Container bridge-alpine3</span>$ tcpdump -i vethd234967 -v -nn -e -ttcpdump: listening on vethd234967, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes02:42:ac:11:00:03 <span class="token operator">></span> ff:ff:ff:ff:ff:ff, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Network-traffic-analysis"><a href="#Network-traffic-analysis" class="headerlink" title="Network traffic analysis"></a>Network traffic analysis</h3><p>According to the results that are shown above, the process is a bit different:</p><ol><li><strong>Use ARP to get the MAC address of the target container：</strong></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bridge-alpine2 container</span>$ route -nKernel IP routing tableDestination     Gateway         Genmask         Flags Metric Ref    Use Iface<span class="token number">0.0</span>.0.0         <span class="token number">172.17</span>.0.1      <span class="token number">0.0</span>.0.0         UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>According to the IP routing table of container bridge-alpine2 shown above, when the container wants to ping another container in the same subnet(172.17.0.0/16), the message can be directly sent to them, instead of being sent to the gateway. But it needs to know the MAC address of the target container first.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bridge-alpine2's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> ff:ff:ff:ff:ff:ff, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span><span class="token comment"># docker0's packcages </span>02:42:ac:11:00:03 <span class="token operator">></span> **ff:ff:ff:ff:ff:ff**, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span><span class="token comment"># bridge-alpine's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> **ff:ff:ff:ff:ff:ff**, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.2 is-at 02:42:ac:11:00:02, length <span class="token number">28</span><span class="token comment"># bridge-alpine3's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> **ff:ff:ff:ff:ff:ff**, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has <span class="token number">172.17</span>.0.2 tell <span class="token number">172.17</span>.0.3, length <span class="token number">28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>So, from the content shown above, we can observe that the container broadcasted the ARP message using the broadcast MAC address(<strong>ff:ff:ff:ff:ff:ff</strong>). ARP request will be sent to all the containers which are connecting to docker0, but only the target container bridge-alpine(172.17.0.2) replied with its MAC address(02:42:ac:11:00:02).</p><ol><li><strong>Send packages (ICMP)</strong></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bridge-alpine2's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">56762</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">17</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">55430</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">17</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span class="token comment"># docker0's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">7910</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59835</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span class="token comment"># bridge-alpine's packages</span>02:42:ac:11:00:03 <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">7910</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.3 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>02:42:ac:11:00:02 <span class="token operator">></span> 02:42:ac:11:00:03, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59835</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">172.17</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">16</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With the IP and MAC address, now container bridge-alpine2 can start to send IMCP messages to container bridge-alpine:</p><p><img src="docker_bridge_internal.png" alt="docker_bridge_internal.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="docker_bridge_internal.png" class="lozad post-image"></p><h2 id="Communicate-with-external-network"><a href="#Communicate-with-external-network" class="headerlink" title="Communicate with external network"></a>Communicate with external network</h2><p>Let’s see what will happen if this container tries to access an <code>external network</code>. The original state of the local environment is shown below:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Show the system ARP cache </span>$ arp -vAddress                  HWtype  HWaddress           Flags Mask            Ifacegateway                  ether   <span class="token number">70</span>:db:98:82:a1:c0   C                     ens192<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Container bridge-alpine2 and bridge-alpine3 have been removed from the local host.</p><p>We can ping a website from a container and use <code>tcpdump</code> to catch the packets during this process:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Ping a website from container with bridge network type</span>$ docker <span class="token builtin class-name">exec</span> bridge-alpine <span class="token function">ping</span> www.baidu.comPING www.baidu.com <span class="token punctuation">(</span><span class="token number">103.235</span>.46.40<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes<span class="token number">64</span> bytes from <span class="token number">103.235</span>.46.40: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">40</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">186.518</span> ms<span class="token number">64</span> bytes from <span class="token number">103.235</span>.46.40: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">40</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">187.523</span> ms<span class="token punctuation">..</span>.<span class="token comment"># Get packets from one of the endpoints of the veth pairs which connects </span><span class="token comment"># container's network namespace and docker0</span>$ tcpdump -i veth80ec58c -v -nn -e02:42:ac:11:00:02 <span class="token operator">></span> 02:42:a1:f9:0a:ad, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has **172.17.0.1** tell <span class="token number">172.17</span>.0.2, length <span class="token number">28</span>02:42:a1:f9:0a:ad <span class="token operator">></span> 02:42:ac:11:00:02, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.1 is-at **02:42:a1:f9:0a:ad**, length <span class="token number">2806</span>:38:42.580163 ARP, Reply localhost.localdomain is-at 02:42:8a:b4:55:4d <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span>, length <span class="token number">28</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">46041</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.8.8.53: <span class="token number">28492</span>+ A? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">53494</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.4.4.53: <span class="token number">28492</span>+ A? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">46042</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.8.8.53: <span class="token number">29411</span>+ AAAA? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">53495</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.4.4.53: <span class="token number">29411</span>+ AAAA? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">132</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">101</span>, <span class="token function">id</span> <span class="token number">57650</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">118</span><span class="token punctuation">)</span>    <span class="token number">8.8</span>.8.8.53 <span class="token operator">></span> <span class="token number">172.17</span>.0.2.37221: <span class="token number">28492</span> <span class="token number">3</span>/0/0 www.baidu.com. CNAME www.a.shifen.com., www.a.shifen.com. A <span class="token number">14.215</span>.177.38, www.a.shifen.com. A <span class="token number">14.215</span>.177.39 <span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">157</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">101</span>, <span class="token function">id</span> <span class="token number">29948</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">143</span><span class="token punctuation">)</span>    <span class="token number">8.8</span>.8.8.53 <span class="token operator">></span> <span class="token number">172.17</span>.0.2.37221: <span class="token number">29411</span> <span class="token number">1</span>/1/0 www.baidu.com. CNAME www.a.shifen.com. <span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">31149</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">14.215</span>.177.38: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">69</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">51</span>, <span class="token function">id</span> <span class="token number">31149</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">14.215</span>.177.38 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">69</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Network-traffic-analysis-1"><a href="#Network-traffic-analysis-1" class="headerlink" title="Network traffic analysis"></a>Network traffic analysis</h3><p>There’re several steps shown in this process, let’s go through them one by one:</p><ol><li><strong>Use ARP to get the MAC address of the gateway：</strong></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bridge-alpine container</span>$ route -nKernel IP routing tableDestination     Gateway         Genmask         Flags Metric Ref    Use Iface<span class="token number">0.0</span>.0.0         <span class="token number">172.17</span>.0.1      <span class="token number">0.0</span>.0.0         UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Different from communicating with containers also connecting to docker0, Both DNS/ICMP messages need to be sent to external networks. In this case, according to the table shown above, container bridge-alpine should directly send messages to the gateway(172.17.0.1)</p><p>Somehow knowing the IP of the gateway is not enough for the packages to be delivered, they need the MAC address as well, so that the container used <code>ARP</code> to ask for the <code>MAC address</code> of the gateway(do not need to board cast):</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">02:42:ac:11:00:02 <span class="token operator">></span> 02:42:a1:f9:0a:ad, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Request who-has **172.17.0.1** tell <span class="token number">172.17</span>.0.2, length <span class="token number">28</span>02:42:a1:f9:0a:ad <span class="token operator">></span> 02:42:ac:11:00:02, ethertype ARP <span class="token punctuation">(</span>0x0806<span class="token punctuation">)</span>, length <span class="token number">42</span>: Ethernet <span class="token punctuation">(</span>len <span class="token number">6</span><span class="token punctuation">)</span>, IPv4 <span class="token punctuation">(</span>len <span class="token number">4</span><span class="token punctuation">)</span>, Reply <span class="token number">172.17</span>.0.1 is-at **02:42:a1:f9:0a:ad**, length <span class="token number">2806</span>:38:42.580163 ARP, Reply localhost.localdomain is-at 02:42:8a:b4:55:4d <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span>, length <span class="token number">28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>According to what we’ve got previously, the MAC address <code>02:42:a1:f9:0a:ad</code> the container got from ARP is the MAC address of docker0 on the host computer:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">ip</span> <span class="token function">link</span> show<span class="token punctuation">..</span>.<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN mode DEFAULT group default     link/ether **02:42:8a:b4:55:4d** brd ff:ff:ff:ff:ff:ff<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><strong>Resolve domain name (DNS)：</strong></li></ol><p>Also, the container needs to know the IP address of the target website, so that it will ask the name server(8.8.8.8) in order to resolve the domain name:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">46041</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.8.8.53: <span class="token number">28492</span>+ A? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">53494</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.4.4.53: <span class="token number">28492</span>+ A? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">46042</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.8.8.53: <span class="token number">29411</span>+ AAAA? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">73</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">53495</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">59</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2.37221 <span class="token operator">></span> <span class="token number">8.8</span>.4.4.53: <span class="token number">29411</span>+ AAAA? www.baidu.com. <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">132</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">101</span>, <span class="token function">id</span> <span class="token number">57650</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">118</span><span class="token punctuation">)</span>    <span class="token number">8.8</span>.8.8.53 <span class="token operator">></span> <span class="token number">172.17</span>.0.2.37221: <span class="token number">28492</span> <span class="token number">3</span>/0/0 www.baidu.com. CNAME www.a.shifen.com., www.a.shifen.com. A <span class="token number">14.215</span>.177.38, www.a.shifen.com. A <span class="token number">14.215</span>.177.39 <span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">157</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">101</span>, <span class="token function">id</span> <span class="token number">29948</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto UDP <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>, length <span class="token number">143</span><span class="token punctuation">)</span>    <span class="token number">8.8</span>.8.8.53 <span class="token operator">></span> <span class="token number">172.17</span>.0.2.37221: <span class="token number">29411</span> <span class="token number">1</span>/1/0 www.baidu.com. CNAME www.a.shifen.com. <span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>I’m not going to talk about the detail of DNS in this article. We only need to know that eventually, the container knew that the target IP is <code>14.215.177.38</code>.</p><ol><li><strong>Send packages (ICMP):</strong></li></ol><p>Now that the container’s already got the IP address of the target website and the MAC address of the gateway, it can send all the ICMP packages now:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">02:42:ac:11:00:02 <span class="token operator">></span> **02:42:a1:f9:0a:ad**, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">31149</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">172.17</span>.0.2 <span class="token operator">></span> <span class="token number">14.215</span>.177.38: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">69</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span>**02:42:a1:f9:0a:ad** <span class="token operator">></span> 02:42:ac:11:00:02, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">51</span>, <span class="token function">id</span> <span class="token number">31149</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">14.215</span>.177.38 <span class="token operator">></span> <span class="token number">172.17</span>.0.2: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">69</span>, <span class="token function">seq</span> <span class="token number">0</span>, length <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>If we also use <code>tcpdump</code> to catch the package from ens192, we will get these contents:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ tcpdump -i ens192 -v -nn -e -t <span class="token function">host</span> <span class="token number">14.215</span>.177.3800:50:56:ba:06:b7 <span class="token operator">></span> <span class="token number">70</span>:db:98:82:a1:c0, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">63</span>, <span class="token function">id</span> <span class="token number">13766</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">10.103</span>.80.33 <span class="token operator">></span> <span class="token number">14.215</span>.177.38: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">113</span>, <span class="token function">seq</span> <span class="token number">20</span>, length <span class="token number">64</span><span class="token number">70</span>:db:98:82:a1:c0 <span class="token operator">></span> 00:50:56:ba:06:b7, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token punctuation">(</span>tos 0x20, ttl <span class="token number">41</span>, <span class="token function">id</span> <span class="token number">13766</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>    <span class="token number">45.113</span>.192.101 <span class="token operator">></span> <span class="token number">10.103</span>.80.33: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">113</span>, <span class="token function">seq</span> <span class="token number">20</span>, length <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The whole process can be shown as:<br><img src="docker_bridge_external.png" alt="docker_bridge_external.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="docker_bridge_external.png" class="lozad post-image"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Overview&quot;&gt;&lt;a href=&quot;#Overview&quot; class=&quot;headerlink&quot; title=&quot;Overview&quot;&gt;&lt;/a&gt;Overview&lt;/h1&gt;&lt;p&gt;According to docker’s official document, docke</summary>
      
    
    
    
    
    <category term="Docker" scheme="http://lzreload.com/en/tags/Docker/"/>
    
    <category term="Network" scheme="http://lzreload.com/en/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>About Kubernetes configuration: ConfigMap</title>
    <link href="http://lzreload.com/en/2022/05/08/About-Kubernetes-configuration-ConfigMap/"/>
    <id>http://lzreload.com/en/2022/05/08/About-Kubernetes-configuration-ConfigMap/</id>
    <published>2022-05-08T11:38:32.000Z</published>
    <updated>2022-09-16T11:10:12.628Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kubernete-Configuration-ConfigMap"><a href="#Kubernete-Configuration-ConfigMap" class="headerlink" title="Kubernete Configuration - ConfigMap"></a>Kubernete Configuration - ConfigMap</h1><h1 id="Creating-ConfigMap"><a href="#Creating-ConfigMap" class="headerlink" title="Creating ConfigMap"></a>Creating ConfigMap</h1><h2 id="Create-from-folder"><a href="#Create-from-folder" class="headerlink" title="Create from folder"></a>Create from folder</h2><p><code>kubectl create folder-cm --from-file &lt;folder_name&gt;</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Create with folder</span>$ kubectl create folder-cm --from-file config$ kubectl get cm/folder-cm -o yamlapiVersion: v1data:  config.txt: <span class="token operator">|</span>    <span class="token assign-left variable">Test</span><span class="token operator">=</span>test  test.txt: <span class="token operator">|</span>    <span class="token assign-left variable">DONT</span><span class="token operator">=</span>KNOWkind: ConfigMapmetadata:  creationTimestamp: <span class="token string">"2022-05-02T15:53:44Z"</span>  name: folder-cm  namespace: default  resourceVersion: <span class="token string">"41428"</span>  uid: 9f71a652-2350-4d55-be6e-5ef468cd45f8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Create-from-file"><a href="#Create-from-file" class="headerlink" title="Create from file"></a>Create from file</h2><p>💡Can create with multiple files, if create with all the files in the same folder, it’s same with creating from folder:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## Create with file</span>$ kubectl create cm file-cm --from-file config/config.txt --from-file config/test.txt$ kubectl get cm/file-cm -o yamlapiVersion: v1data:  config.txt: <span class="token operator">|</span>    <span class="token assign-left variable">Test</span><span class="token operator">=</span>test  test.txt: <span class="token operator">|</span>    <span class="token assign-left variable">DONT</span><span class="token operator">=</span>KNOWkind: ConfigMapmetadata:  creationTimestamp: <span class="token string">"2022-05-02T16:03:36Z"</span>  name: file-cm  namespace: default  resourceVersion: <span class="token string">"42433"</span>  uid: 17766fc1-cfd5-4b95-b00f-296844f23407<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The name of the file will be the key of key-value pair in <code>ConfigMap</code> while the content of the file will be the value.</p><p>If we want some specific keys, we can create the ConfigMap with given key:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl create cm key-cm --from-file<span class="token operator">=</span>key<span class="token operator">=</span>config.txt$ kubectl get cm/key-cm -o yamlapiVersion: v1data:  key: <span class="token operator">|</span>    <span class="token assign-left variable">DB_URL</span><span class="token operator">=</span>localhost:3306    <span class="token assign-left variable">DB_USERNAME</span><span class="token operator">=</span>postgreskind: ConfigMapmetadata:  creationTimestamp: <span class="token string">"2022-05-03T15:16:25Z"</span>  name: key-cm  namespace: default  resourceVersion: <span class="token string">"63721"</span>  uid: eb3c93ca-fcfc-42bd-82ce-2d8cddbfc900<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Create-from-key-value-pairs"><a href="#Create-from-key-value-pairs" class="headerlink" title="Create from key-value pairs"></a>Create from key-value pairs</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl create cm value-cm --from-literal<span class="token operator">=</span>Test<span class="token operator">=</span>test$ kubectl get cm/value-cm -o yamlapiVersion: v1data:  Test: <span class="token builtin class-name">test</span>kind: ConfigMapmetadata:  creationTimestamp: <span class="token string">"2022-05-03T15:26:07Z"</span>  name: value-cm  namespace: default  resourceVersion: <span class="token string">"64703"</span>  uid: f5431bb3-6276-48e8-85e0-33b0ef1a7243<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Create-from-env-file"><a href="#Create-from-env-file" class="headerlink" title="Create from env file"></a>Create from env file</h2><p>💡env file can be .<code>env</code> file and <code>.txt</code> file and so on ..</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl create cm env-cm --from-env-file<span class="token operator">=</span>config.txt$ kubectl get cm/env-cm -o yamlapiVersion: v1data:  DB_URL: localhost:3306  DB_USERNAME: postgreskind: ConfigMapmetadata:  creationTimestamp: <span class="token string">"2022-05-03T15:30:49Z"</span>  name: env-cm  namespace: default  resourceVersion: <span class="token string">"65184"</span>  uid: 60dba811-8fa9-4bb1-9e7b-9d45a02009eb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Comparing with <code>Create from file</code>, in which same file is used to create configMap, instead of using filename/given key as key, and file content as value, <code>creating from env file</code> reads the file first, and uses <code>key-value pairs</code> in the file to create ConfigMap.</p><h1 id="Using-configMap"><a href="#Using-configMap" class="headerlink" title="Using configMap"></a>Using configMap</h1><h2 id="Use-ConfigMap-as-files-in-pod"><a href="#Use-ConfigMap-as-files-in-pod" class="headerlink" title="Use ConfigMap as files in pod"></a>Use ConfigMap as files in pod</h2><h3 id="Mount-configMap"><a href="#Mount-configMap" class="headerlink" title="Mount configMap"></a>Mount configMap</h3><p>ConfigMap can be mounted to pods as volumes. Here is the yaml file of a pod who mounts all the ComfigMaps we’ve created above (folder-cm, file-cm, value-cm, env-cm):</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># file-pod.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> file<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> folder      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"folder"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"file"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> value      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"value"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> env      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"env"</span>  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> folder    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> folder<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> file<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> value    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> value<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> env    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>cm<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then if we log into the pod and check what is going on inside:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> -it pod/file-pod -- <span class="token function">bash</span><span class="token comment"># Inside pod</span>$ tree -L <span class="token number">2</span><span class="token punctuation">..</span>.<span class="token operator">|</span>-- <span class="token function">env</span><span class="token operator">|</span>   <span class="token operator">|</span>-- DB_URL -<span class="token operator">></span> <span class="token punctuation">..</span>data/DB_URL<span class="token operator">|</span>   <span class="token variable"><span class="token variable">`</span>-- DB_USERNAME -<span class="token operator">></span> <span class="token punctuation">..</span>data/DB_USERNAME<span class="token operator">|</span>-- <span class="token function">file</span><span class="token operator">|</span>   <span class="token operator">|</span>-- config.txt -<span class="token operator">></span> <span class="token punctuation">..</span>data/config.txt<span class="token operator">|</span>   <span class="token variable">`</span></span>-- test.txt -<span class="token operator">></span> <span class="token punctuation">..</span>data/test.txt<span class="token operator">|</span>-- folder<span class="token operator">|</span>   <span class="token operator">|</span>-- config.txt -<span class="token operator">></span> <span class="token punctuation">..</span>data/config.txt<span class="token operator">|</span>   <span class="token variable"><span class="token variable">`</span>-- test.txt -<span class="token operator">></span> <span class="token punctuation">..</span>data/test.txt<span class="token operator">|</span>-- value<span class="token operator">|</span>   <span class="token variable">`</span></span>-- Test -<span class="token operator">></span> <span class="token punctuation">..</span>data/Test<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Apparently, no matter from what we created the <code>ConfigMap</code>, the pod who mounted them would generate a file for each key-value pairs in <code>ConfigMap</code> using key as filename and value as content.</p><p>💡Mounting ConfigMap to pods as volumes is setting to <code>Read-Only</code> by default.</p><h3 id="Mount-ConfigMap-with-SubPath"><a href="#Mount-ConfigMap-with-SubPath" class="headerlink" title="Mount ConfigMap with SubPath"></a>Mount ConfigMap with SubPath</h3><p>It’s mentioned that when we mount a <code>ConfigMap</code> to a pod, a folder named as what is specified in <code>spec.containers.volumeMounts.mountPath</code> in the yaml file will be created (if there’s already a folder with same name, the original folder will be covered and the files in this folder cannot been seen anymore.)</p><p>But there will be a situation that we only want to create a file based on the <code>ConfigMap</code> and put it into a folder which already exited. </p><p>For example, folder <code>/etc/nginx/conf.d</code> which already has a file <code>default.conf</code> for Nginx. Instead of making this file disappear, we only want to add a new file into this folder. Then we need <code>SubPath</code>:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># file-pod2</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> file<span class="token punctuation">-</span>pod2<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> folder      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"folder"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/etc/nginx/conf.d/config.txt"</span>      <span class="token key atrule">subPath</span><span class="token punctuation">:</span> <span class="token string">"config.txt"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> value      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"value"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> env      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"env"</span>  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> folder    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> folder<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> file<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> value    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> value<span class="token punctuation">-</span>cm  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> env    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>cm<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>According to documentation of <code>Kubernetes 1.24</code>:</p><blockquote><p>The <code>volumeMounts.subPath</code>property specifies a sub-path inside the referenced volume instead of its root.</p></blockquote><p>So, consider each volume is a folder, then for <code>file</code> volume, it contains <code>config.txt</code> file and <code>text.txt</code> file. Then we can use relative path “config.txt” to point to <code>config.txt</code> file of <code>file volume</code> in <code>spec.containers.volumeMounts.subPath</code> property.</p><p>If we apply this yaml file again and log into the new pod:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span><span class="token punctuation">..</span>. <span class="token function">env</span> folder value <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Other folders are still here but just <code>file</code> folder is gone. Then we can check <code>/etc/nginx/conf.d</code> folder.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span> /etc/nginx/conf.dconfig.txt  default.conf$ <span class="token function">cat</span> /etc/nginx/conf.d/config.txt<span class="token assign-left variable">Test</span><span class="token operator">=</span>test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>default.conf</code> file is still here and only <code>config.txt</code> file which is specified in <code>subPath</code> is create in this folder.</p><h3 id="Update-ConfigMap"><a href="#Update-ConfigMap" class="headerlink" title="Update ConfigMap"></a>Update ConfigMap</h3><p>Now, let’s see what will happen if we try to modify a ConfigMap. We edit two ConfigMaps: <code>file-cm</code> and <code>value-cm</code>:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#file-cm</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">config.txt</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    Test=file-modified</span>  <span class="token key atrule">test.txt</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    DONT=KNOW</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-05-02T16:03:36Z"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> file<span class="token punctuation">-</span>cm  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"281558"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 17766fc1<span class="token punctuation">-</span>cfd5<span class="token punctuation">-</span>4b95<span class="token punctuation">-</span>b00f<span class="token punctuation">-</span>296844f23407<span class="token comment">#value-cm</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">Test</span><span class="token punctuation">:</span> value<span class="token punctuation">-</span>modified<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-05-03T15:26:07Z"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> value<span class="token punctuation">-</span>cm  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"317489"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> f5431bb3<span class="token punctuation">-</span>6276<span class="token punctuation">-</span>48e8<span class="token punctuation">-</span>85e0<span class="token punctuation">-</span>33b0ef1a7243<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then we can log into file-pod2, which we created in previous section, and check what happened after we modified the <code>ConfigMap</code>:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> -it pod/file-pod2 -- <span class="token function">bash</span><span class="token comment"># Content has been updated</span>$ <span class="token function">cat</span> value/Testvalue-modified<span class="token comment"># Content remains the same</span>$ <span class="token function">cat</span> /etc/nginx/conf.d/config.txt<span class="token assign-left variable">Test</span><span class="token operator">=</span>test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>According to the result, after a <code>ConfigMap</code> is changed, the container who mounted this <code>ConfigMap</code> as volume will be updated as well. But there are several exceptions. </p><p>One of these exceptions is that if the container uses the <code>ConfigMap</code> as <code>SubPath</code> volume, then it won’t receive the update.</p><p>💡<code>ConfigMap</code> can be set immutable, <code>immutable ConfigMap</code> will not be watched constantly, which can reduce load on kube-<code>apiserver</code>.</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token punctuation">...</span><span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token punctuation">...</span><span class="token key atrule">immutable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Use-ConfigMap-as-environment-variables-in-pod"><a href="#Use-ConfigMap-as-environment-variables-in-pod" class="headerlink" title="Use ConfigMap as environment variables in pod"></a>Use ConfigMap as environment variables in pod</h2><h3 id="Using-specific-values-in-ConfigMap-as-environment-variables"><a href="#Using-specific-values-in-ConfigMap-as-environment-variables" class="headerlink" title="Using specific values in ConfigMap as environment variables"></a>Using specific values in ConfigMap as environment variables</h3><p>In order to use specific values in ConfigMap as <code>environment variables</code> in container, we used <code>spec.containers.env.valueFrom.configMapKeyRef</code>:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># env-pod.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FOLDER_KEY      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> folder<span class="token punctuation">-</span>cm          <span class="token key atrule">key</span><span class="token punctuation">:</span> test.txt    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENV_KEY      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>cm          <span class="token key atrule">key</span><span class="token punctuation">:</span> DB_URL  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then create a new pod with this yaml file and checke the environment variables of it’s container:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> pod/env-pod -- <span class="token function">env</span><span class="token punctuation">..</span>.<span class="token assign-left variable">FOLDER_KEY</span><span class="token operator">=</span>DONT<span class="token operator">=</span>KNOW<span class="token assign-left variable">ENV_KEY</span><span class="token operator">=</span>localhost:3306<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The name of the variables are what we specified with <code>spec.containers.env.name</code>. Then it will search in the target <code>ConfigMap</code> which we specified with <code>spec.env.valueFrom.configMapKeyRef.name</code> in order to find the target key-value pair whose key equals to what we specified in <code>spec.env.valueFrom.configMapKeyRef.key</code>. The value of this environment variable will be the value of target key-value pair.</p><h3 id="Using-all-values-in-ConfigMap-as-environment-variables"><a href="#Using-all-values-in-ConfigMap-as-environment-variables" class="headerlink" title="Using all values in ConfigMap as environment variables"></a>Using all values in ConfigMap as <strong><strong>environment variables</strong></strong></h3><p>Here we will use <code>spec.containers.envFrom.configMapRef</code> to inject all the key-value pairs of a <code>ConfigMap</code> to a container as environment variables:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># all-env-pod.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> all<span class="token punctuation">-</span>env<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>cm  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After this yaml file is applied, the environment variables of the new containers are:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">$ kubectl exec pod/all<span class="token punctuation">-</span>env<span class="token punctuation">-</span>pod <span class="token punctuation">-</span><span class="token punctuation">-</span> env<span class="token punctuation">...</span>DB_URL=localhost<span class="token punctuation">:</span><span class="token number">3306</span>DB_USERNAME=postgres<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>All the key-value pairs of <code>ConfigMap</code> are used as environment variable and their keys are the variable names while their values are the variable values.</p><h3 id="Update-ConfigMap-1"><a href="#Update-ConfigMap-1" class="headerlink" title="Update ConfigMap"></a>Update ConfigMap</h3><p>Same as what we mentioned in previous section - <code>Use ConfigMap as files in pod</code>, we are going to modified the ConfigMap and see what will happen to corresponding containers:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## env-cm</span><span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">DB_URL</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span>3306_modified  <span class="token key atrule">DB_USERNAME</span><span class="token punctuation">:</span> postgres<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-05-03T15:30:49Z"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>cm  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"65184"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 60dba811<span class="token punctuation">-</span>8fa9<span class="token punctuation">-</span>4bb1<span class="token punctuation">-</span>9e7b<span class="token punctuation">-</span>9d45a02009eb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>We changed the value of <code>DB_URL</code>, then environment variables of the previous two containers are:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> pod/env-pod -- <span class="token function">env</span><span class="token punctuation">..</span>.<span class="token assign-left variable">FOLDER_KEY</span><span class="token operator">=</span>DONT<span class="token operator">=</span>KNOW<span class="token assign-left variable">ENV_KEY</span><span class="token operator">=</span>localhost:3306<span class="token punctuation">..</span>.$ kubectl <span class="token builtin class-name">exec</span> pod/all-env-pod -- <span class="token function">env</span><span class="token punctuation">..</span>.<span class="token assign-left variable">DB_URL</span><span class="token operator">=</span>localhost:3306<span class="token assign-left variable">DB_USERNAME</span><span class="token operator">=</span>postgres<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The environment variables who are created from ConfigMap remain the same. This is the other situation that we talked about before in which corresponding containers will not receive the update of the ConfigMap.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Kubernete-Configuration-ConfigMap&quot;&gt;&lt;a href=&quot;#Kubernete-Configuration-ConfigMap&quot; class=&quot;headerlink&quot; title=&quot;Kubernete Configuration - </summary>
      
    
    
    
    
    <category term="Kubernetes" scheme="http://lzreload.com/en/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Go: About package heap</title>
    <link href="http://lzreload.com/en/2022/04/15/Golang-Heap/"/>
    <id>http://lzreload.com/en/2022/04/15/Golang-Heap/</id>
    <published>2022-04-15T09:21:52.000Z</published>
    <updated>2022-09-16T11:33:33.115Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h2><p>Package <code>heap</code> defines <code>Interface</code> which contains <code>Interface</code> of package <code>sort</code>, and two methods: Push and Pop.</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go1.18.1/src/container/heap/heap.go</span><span class="token keyword">package</span> heap<span class="token keyword">import</span> <span class="token string">"sort"</span><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>sort<span class="token punctuation">.</span>Interface<span class="token function">Push</span><span class="token punctuation">(</span>x any<span class="token punctuation">)</span> <span class="token comment">// add x as element Len()</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any   <span class="token comment">// remove and return element Len() - 1.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Interface</code> of package <code>sort</code> has 3 methods: Len, Less and Swap :</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> sort<span class="token comment">// An implementation of Interface can be sorted by the routines in this package.</span><span class="token comment">// The methods refer to elements of the underlying collection by integer index.</span><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token comment">// Len is the number of elements in the collection.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token comment">// Less reports whether the element with index i</span><span class="token comment">// must sort before the element with index j.</span><span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token comment">// Swap swaps the elements with indexes i and j.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It mains that in order to implement <code>Interface</code> of package heap, our structure should have 5 methods: Len, Less, Swap, Push and Pop.</p><p>For example:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> MinHeap <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m MinHeap<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m MinHeap<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m MinHeap<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MinHeap<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>x any<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MinHeap<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">&#123;</span>size <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span>last <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">return</span> last<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Above is a new structure named MinHeap which implements all the methods of <code>Interface</code> in package <code>heap</code>.</p><p>Now that we’ve already defined a structure which has all these 5 methods, how do we use this package and how does this package work?</p><h2 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h2><p>There are 5 public functions in this package:</p><h3 id="Init"><a href="#Init" class="headerlink" title="Init"></a>Init</h3><p><code>Init</code> function will build a heap with given <code>Interface</code> who contains all the data.</p><p>According to the code from this package, <code>Init</code> will perform bottom-up construction in order to build the heap from array with O(n) time complexity. </p><ul><li>It will start from the last non-leaf node and swap it with its smallest child if this subtree does not meet the requirement of <code>Minheap</code>(In this example, we defined a minHeap, whose requirement is the parent node must smaller than all its childs). Here it will call the <code>Less</code> and <code>Swap</code> function which we defined for the <code>MinHeap</code> previously in order to compare and swap two nodes.</li><li>Then it will move to the next non-leaf node and keep swapping until the whole tree become a <code>MinHeap</code></li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// heapify</span>n <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> n<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">&#123;</span><span class="token function">down</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">down</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> i0<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>i <span class="token operator">:=</span> i0<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>j1 <span class="token operator">:=</span> <span class="token number">2</span><span class="token operator">*</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token keyword">if</span> j1 <span class="token operator">>=</span> n <span class="token operator">||</span> j1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> <span class="token comment">// j1 &lt; 0 after int overflow</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span>j <span class="token operator">:=</span> j1 <span class="token comment">// left child</span><span class="token keyword">if</span> j2 <span class="token operator">:=</span> j1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j2 <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j2<span class="token punctuation">,</span> j1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>j <span class="token operator">=</span> j2 <span class="token comment">// = 2*i + 2  // right child</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span>h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>i <span class="token operator">=</span> j<span class="token punctuation">&#125;</span><span class="token keyword">return</span> i <span class="token operator">></span> i0<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With the <code>MinHeap</code> struct which we’ve just define before:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Heap] Start heap tast, creating original array ..."</span><span class="token punctuation">)</span>mh <span class="token operator">:=</span> <span class="token operator">&amp;</span>MinHeap<span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Original array :%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Heap] Start to build minHeap..."</span><span class="token punctuation">)</span>heap<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>Init</code> function will build the heap like this:</p><p><img src="build_heap.png" alt="build_heap.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="build_heap.png" class="lozad post-image"></p><p>The output of previous code will be:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ go run main.go<span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Start heap tast, creating original array <span class="token punctuation">..</span>.<span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Original array :<span class="token punctuation">[</span><span class="token number">5</span> <span class="token number">3</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">2</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Start to build minHeap<span class="token punctuation">..</span>.<span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap:<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">3</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Pop"><a href="#Pop" class="headerlink" title="Pop"></a>Pop</h3><p><code>Pop</code> function will swap the root with the last node of the array and shorten the length of current array in order to exclude this minimum data in the upcoming action.</p><p>Then it will move the current root down in order to build a new <code>MinHeap</code>.</p><p>After that, this function will call the <code>Pop</code> function we defined for the <code>MinHeap</code> struct before to return the last node which is the minimum data in the structure:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Pop removes and returns the minimum element (according to Less) from the heap.</span><span class="token comment">// The complexity is O(log n) where n = h.Len().</span><span class="token comment">// Pop is equivalent to Remove(h, 0).</span><span class="token keyword">func</span> <span class="token function">Pop</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">)</span> any <span class="token punctuation">&#123;</span>n <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token function">down</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Still, with the same <code>MinHeap</code> struct:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>first <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Pop:%d MinHeap:%v\n"</span><span class="token punctuation">,</span> first<span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>Pop</code> function will process the <code>Minheap</code> as:</p><p><img src="pop_heap.png" alt="pop_heap.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="pop_heap.png" class="lozad post-image"></p><p>The output of previous code will be:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.<span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap:<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">3</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Pop:1 MinHeap:<span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Push"><a href="#Push" class="headerlink" title="Push"></a>Push</h3><p><code>Push</code> function will first call the <code>Push</code> method of the given interface(<code>MinHeap</code>) in order to put the new node to the end of the array.</p><p>Then it will keep moving this new node up using <code>MinHeap</code>‘s <code>Less</code> and <code>Swap</code> methods to make sure that the new array still meets the requirement of <code>MinHeap</code>.</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Push pushes the element x onto the heap.</span><span class="token comment">// The complexity is O(log n) where n = h.Len().</span><span class="token keyword">func</span> <span class="token function">Push</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> x any<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>h<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token function">up</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">up</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>i <span class="token operator">:=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// parent</span><span class="token keyword">if</span> i <span class="token operator">==</span> j <span class="token operator">||</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span>h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>j <span class="token operator">=</span> i<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With the same <code>MinHeap</code> struct:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>first <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Pop:%d MinHeap:%v\n"</span><span class="token punctuation">,</span> first<span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>mh<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Push:%d MinHeap:%v\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>Push</code> function will process like this:</p><p><img src="push_heap.png" alt="push_heap.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="push_heap.png" class="lozad post-image"></p><p>And the output of previous code will be:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.<span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap:<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">3</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Pop:1 MinHeap:<span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Push:4 MinHeap:<span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Fix"><a href="#Fix" class="headerlink" title="Fix"></a>Fix</h3><p><code>Fix</code> function of package heap can be used when one of the node’s value is changed. In this situation, we don’t need to use Init to rebuild the whole tree, we only need to move this node down/up in order to make the array to meet the requirement again:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Fix re-establishes the heap ordering after the element at index i has changed its value.</span><span class="token comment">// Changing the value of the element at index i and then calling Fix is equivalent to,</span><span class="token comment">// but less expensive than, calling Remove(h, i) followed by a Push of the new value.</span><span class="token comment">// The complexity is O(log n) where n = h.Len().</span><span class="token keyword">func</span> <span class="token function">Fix</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">down</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> i<span class="token punctuation">,</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">up</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>down</code> function will return a boolean value to indicate whether the position of target node has been changed in previous process. If not, it means that it might need to move up.</p><p>For example:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Changing one node of minHeap %v..\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap will be fixed:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>heap<span class="token punctuation">.</span><span class="token function">Fix</span><span class="token punctuation">(</span>mh<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap after fix:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Changing one node of minHeap %v..\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>heap<span class="token punctuation">.</span><span class="token function">Fix</span><span class="token punctuation">(</span>mh<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap after fix:%v\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>Fix</code> function will process like this:</p><p><img src="Fix_heap.png" alt="Fix_heap.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="Fix_heap.png" class="lozad post-image"></p><p>And the output of previous code will be:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Changing one node of minHeap <span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap will be fixed:<span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">6</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap after fix:<span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Changing one node of minHeap <span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap after fix:<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">6</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Remove"><a href="#Remove" class="headerlink" title="Remove"></a>Remove</h3><p><code>Remove</code> function is a bit like the combination of <code>Pop</code> and <code>Fix</code>.</p><ul><li>It will shorten the length of the array in order to exclude the last node in the tree (which will be change to the target node in next step)</li><li>Then it will swap the target node with the last node.</li><li>Coz the value the previous position of target node holds has been changed, this function will act like <code>Fix</code> function to make the array to meet the requirement again.</li><li>Finally it will pop out the current last node which is the target node as well.</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Remove removes and returns the element at index i from the heap.</span><span class="token comment">// The complexity is O(log n) where n = h.Len().</span><span class="token keyword">func</span> <span class="token function">Remove</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">)</span> any <span class="token punctuation">&#123;</span>n <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token keyword">if</span> n <span class="token operator">!=</span> i <span class="token punctuation">&#123;</span>h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">down</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">up</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>For example: </p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token comment">//Remove</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] Removing one node from minHeap %v..\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span>elem <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>mh<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[Heap] MinHeap after removing element %d :%v\n"</span><span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token operator">*</span>mh<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>Remove</code> function will process like this:</p><p><img src="Remove_heap.png" alt="Remove_heap.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="Remove_heap.png" class="lozad post-image"></p><p>And the output of previous code will be:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> Removing one node from minHeap <span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">[</span>Heap<span class="token punctuation">]</span> MinHeap after removing element <span class="token number">2</span> :<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">6</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">7</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Here is mainly all the thing that I want to talk about package <code>Heap</code>. The complete example code can be found in my repo: <a href="https://github.com/lz-nsc/go-example/tree/main/heap">lz-nsz/go-example/heap</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Interfaces&quot;&gt;&lt;a href=&quot;#Interfaces&quot; class=&quot;headerlink&quot; title=&quot;Interfaces&quot;&gt;&lt;/a&gt;Interfaces&lt;/h2&gt;&lt;p&gt;Package &lt;code&gt;heap&lt;/code&gt; defines &lt;cod</summary>
      
    
    
    
    
    <category term="Golang" scheme="http://lzreload.com/en/tags/Golang/"/>
    
  </entry>
  
</feed>
